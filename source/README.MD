# Deep Learning Model to Predict EBV-Associated Gastric Cancer

## Introduction
This repository contains the description & source code for developing a deep learning-based model to predict EBV-associated gastric cancer. 

The model was implemented using Keras API. 

## Workflow
- Our deep learning model, EBVNet, aims in detection of Epstein-Barr virus (EBV) from H&E-stained whole slide images (WSIs). 
<img src="./figures/figure1.jpg" width="60%" height="60%">

- Patch-wise classification
  - 1. From WSI, we extract patch by sliding window method.
  - 2. Tumor classifier (based on ResNet50 or InceptionV3) : Normal vs. Tumor
  - 3. EBV classifier (based on ResNet50 or InceptionV3) : EBV Positive Tumor vs. EBV Negative Tumor 
  
- Slide-wise classification 
  - 1. Patch-wise classification for all the patches extracted from single patient's WSI. 
  - 2. If (# EBV Positive Tumor Patches / # Tumor Patches) exceeds pre-defined threshold, the WSI is classified as EBV Positive. 

## Tissue Patch Generation
- Tissue patches were generated by sliding window method. 
- To remove non-tissue white background, a threshold-based segmentation method was adopted using the Otsu algorithm after the WSIs were transferred to the HSV color space 
- We resized patch to 512 x 512 size. 

## Tumor classifier 
- Tumor classifier was developed based on ResNet50.
- Based on base model (ResNet50), Tumor classifier returns the probability for tumor of input patch. 
  - Additional layers were appended to the base model. 
    - GlobalAveragePooling layer 
    - Dropout layer 
    - Dense layer (with ReLU activation function)
    - Dropout layer
    - Dense layer (with Sigmoid activation) 
  - Augmentation
    - All the patches for training and validation were augmented by rotation (90, 180, 270 degree) and flipping (vertical & horizontal).  
    - For extra augmentation of patches, we used [Albumentations](https://albumentations.ai/) library.
      ```
      train_transforms = albumentations.Compose([
        albumentations.HorizontalFlip(p=0.5),
        albumentations.VerticalFlip(p=0.5),
        albumentations.ElasticTransform(p=0.5),
        albumentations.HueSaturationValue(p=0.5),
        albumentations.RandomBrightnessContrast(p=0.5),
      ])
      ```
  - Hyperparameters
    - Adam optimizer (initial learning rate 1e-3)
    - Loss : Binary crossentropy 
    - Metrics : Accuracy
    - Callbacks : ReduceLROnPlateau, EarlyStopping

- We provide the weights of trained Tumor classifiers. All the models requires input size of 512 x 512. 
  - 1) `Tumor_classifier.hdf5` : Tumor classifier (based on ResNet50). It was trained with TCGA slides. 
  - 2) `Tumor_classifier_ft.hdf5` : Tumor classifier (based on ResNet50). It was trained with TCGA slides and fine-tuned with ISH slides. 

## EBV classifier 
- EBV classifier was developed based on InceptionV3.
- Based on base model (InceptionV3), EBV classifier returns the probability for EBV-positive tumor of input patch. 
  - Architecture and hyperparameters are same as Tumor classifier. 

- We provide the weights of trained EBV classifiers. All the models requires input size of 512 x 512. 
  - 1) `EBV_classifier.hdf5` : EBV classifier (based on InceptionV3). It was trained with TCGA slides. 
  - 2) `EBV_classifier_ft.hdf5` : EBV classifier (based on InceptionV3). It was trained with TCGA slides and fine-tuned with ISH slides. 
